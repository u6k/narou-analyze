machine:
    timezone: Asia/Tokyo
    services:
        - docker

compile:
    pre:
        - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
        - docker pull u6kapps/narou-crawler-dev || true
    override:
        - docker build -t u6kapps/narou-crawler-dev -f Dockerfile-dev .
    post:
        - docker push u6kapps/narou-crawler-dev

test:
    override:
        - docker run -d --name narou-crawler-db -e POSTGRES_PASSWORD=$DB_PASS -e POSTGRES_USER=$DB_USER -e POSTGRES_DB=$DB_NAME postgres
        - docker run --rm -v $HOME/.m2:/root/.m2 -v $(pwd):/var/my-app --link narou-crawler-db:db -e NAROU_CRAWLER_DB_USER=$DB_USER -e NAROU_CRAWLER_DB_PASS=$DB_PASS -e NAROU_CRAWLER_DB_NAME=$DB_NAME u6kapps/narou-crawler-dev
        - docker kill narou-crawler-db
    post:
        - cp -r target/surefire-reports/* $CIRCLE_TEST_REPORTS/
        - cp -r target/* $CIRCLE_ARTIFACTS/

deployment:
    release:
        tag: /.+/
        commands:
            - docker build -t u6kapps/narou-crawler .
            - docker tag u6kapps/narou-crawler u6kapps/narou-crawler:$CIRCLE_TAG
            - docker push u6kapps/narou-crawler
