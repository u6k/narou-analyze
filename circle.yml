machine:
    timezone: Asia/Tokyo
    services:
        - docker

compile:
    override:
        - docker build -t narou-analyze-dev -f Dockerfile-dev .

test:
    override:
        - docker run -d --name db -e "POSTGRES_PASSWORD=db_pass" -e "POSTGRES_USER=db_user" -e "POSTGRES_DB=narou_analyze" postgres
        - docker run --rm --name narou_analyze -v "${HOME}/.m2:/root/.m2" -v "${PWD}:/var/my-app" --link db:db -e "NAROU_CRAWLER_DB_USER=db_user" -e "NAROU_CRAWLER_DB_PASS=db_pass" -e "NAROU_CRAWLER_DB_HOST=db" -e "NAROU_CRAWLER_DB_NAME=narou_analyze" narou-analyze-dev
        - docker kill db
        - docker build -t u6kapps/narou-analyze .
    post:
        - cp -r target/surefire-reports/* $CIRCLE_TEST_REPORTS/
        - cp -r target/* $CIRCLE_ARTIFACTS/

deployment:
    release:
        tag: /.+/
        commands:
            - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
            - docker tag u6kapps/narou-analyze u6kapps/narou-analyze:$CIRCLE_TAG
            - docker push u6kapps/narou-analyze
